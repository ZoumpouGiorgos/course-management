<%# app/views/users/show.html.erb %>

<div class="max-w-5xl mx-auto px-4 py-8 space-y-6">

  <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
    <div class="flex items-start justify-between gap-6">
      <div class="flex items-center gap-3 min-w-0">
        <%= render "shared/avatar", user: @user %>

        <div class="min-w-0">
          <p class="text-sm font-semibold text-gray-900 truncate">
            <%= @user.username.presence || "User ##{@user.id}" %>
          </p>
          <p class="text-xs text-gray-500 truncate"><%= @user.email %></p>
        </div>
      </div>

      <div class="flex items-center gap-2 shrink-0">
        <% if user_signed_in? && current_user == @user %>
          <%= link_to "Edit profile",
                edit_user_registration_path,
                class: "text-sm font-medium text-gray-500 hover:text-gray-900 transition" %>

        <% elsif user_signed_in? %>
          <% existing_contact = current_user.contacts.find_by(contact_user: @user) %>

          <% if existing_contact %>
            <%= button_to "Remove contact",
                  contact_path(existing_contact),
                  method: :delete,
                  class: "text-xs px-3 py-1 rounded-full border border-gray-200 text-gray-700 hover:bg-gray-50" %>
          <% else %>
            <%= button_to "Add as contact",
                  contacts_path(contact_user_id: @user.id),
                  method: :post,
                  class: "text-xs px-3 py-1 rounded-full bg-gray-900 text-white hover:bg-gray-800" %>
          <% end %>

          <%= link_to "Message",
                conversations_path(user_id: @user.id),
                data: { turbo_method: :post, turbo_frame: "chat_modal" },
                class: "text-xs px-3 py-1 rounded-full bg-gray-900 text-white hover:bg-gray-800 inline-block" %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="space-y-4">
    <% if @posts.blank? %>
      <div class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm">
        <p class="text-sm text-gray-500">No posts yet.</p>
      </div>
    <% else %>
      <% @posts.each do |post| %>
        <div id="<%= dom_id(post) %>" class="bg-white rounded-2xl border border-gray-200 p-6 shadow-sm space-y-4">
          <div class="flex items-start justify-between gap-4">
            <div class="flex items-center gap-3 min-w-0">
              <%= render "shared/avatar", user: post.user %>

              <div class="min-w-0">
                <p class="text-sm font-semibold text-gray-900 truncate"><%= post.user.username %></p>
                <p class="text-xs text-gray-500"><%= time_ago_in_words(post.created_at) %> ago</p>
              </div>
            </div>

            <%= render "posts/course_pill", post: post %>
          </div>

          <div class="space-y-2">
            <h3 class="text-lg font-semibold text-gray-900"><%= post.title %></h3>
            <p class="text-sm text-gray-600 leading-relaxed"><%= truncate(post.body.to_s, length: 220) %></p>
          </div>

          <div class="flex items-center justify-between pt-2">
            <%= link_to "View post",
                  post_path(post),
                  class: "text-sm font-medium text-gray-500 hover:text-gray-900 transition" %>

            <% if user_signed_in? && current_user == @user %>
              <div class="flex items-center gap-4 text-sm">
                <%= link_to "Edit", edit_post_path(post), class: "text-blue-600 hover:underline" %>
                <%= link_to "Delete",
                      post_path(post),
                      data: { turbo_method: :delete, turbo_confirm: "Are you sure?" },
                      class: "text-red-600 hover:underline" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

</div>